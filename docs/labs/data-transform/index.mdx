---
title: Data Transforms Sandbox
---

<head>
    <meta name="title" content="Data Transforms | Redpanda Docs"/>
    <meta name="description" content="Working with data transformation in Redpanda."/>
    <link rel="canonical" href="https://docs.redpanda.com/docs/labs/data-transform/" />
</head>

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import TechPreviewBadge from '../shared/_datatransform_badge.mdx'

<TechPreviewBadge/>

:::important
Technical Preview features are not supported for production deployments.
:::

Learn about Redpanda Data Transforms and how to create, develop, build, and deploy them to transform records written within Redpanda.

Please share your feedback in Redpanda Community Slack ([#wasm-transforms](https://redpandacommunity.slack.com/archives/C05EAMK60QK)) or in the [feedback form](https://forms.gle/mhYbeG3GzhJZ4xtj7). 

## About data transforms

Redpanda Data Transforms provides a framework to create, build, and deploy inline data transformations on data written to Redpanda clusters. Users develop custom transform functions, and an asynchronous transform engine based on WebAssembly (Wasm) runs them. With data transforms, you can enable common streaming tasks such as data filtering, transcoding, normalization, and scrubbing and cleaning.

You can develop data transforms with [`rpk transform`](../data-transform/rpk-transform) commands. Starting with [`rpk transform init`](../data-transform/rpk-transform-init) to initialize a transform project, you edit a transform YAML configuration file (`transform.yaml`) and a transform Golang source file (`transform.go`) with your custom transform functionality. You then build and deploy the transform to a Redpanda cluster. 

## Data transforms tutorial

This tutorial takes you through the steps to setup, create, build, and deploy a Redpanda Data Transforms project in Golang.

### Prerequisites 

1. Install [Golang](https://go.dev/doc/install) (latest version: 1.20).
1. Install [Docker](https://docs.docker.com/get-docker/).

### Limitations

- The local disk is not accessible in this version. You can cache things in memory in global variables, but the runtime may restart the Wasm module at any point, causing the state to be lost. The `main` function is a good place to initialize any state needed.
- The network is not accessible in this version.
- Protobufs are unsupported.


### Install rpk

1. Download the technical preview of `rpk` that supports Data Transforms for your architecture.

  <Tabs groupId="architectures">
  <TabItem value="arm64" label="Apple silicon" default>

  ```bash
  curl -SLO https://github.com/rockwotj/redpanda/releases/latest/download/rpk-darwin-arm64.zip
  ```

  </TabItem>

  <TabItem value="amd64" label="Linux x86-64">

  ```bash
  curl -SLO https://github.com/rockwotj/redpanda/releases/latest/download/rpk-linux-amd64.zip
  ```

  </TabItem>
  </Tabs>

1. Unzip the downloaded bundle to get the custom `rpk` binary.
1. Set the custom `rpk` binary in your `PATH`.

  :::note
  On macOS, you may need to unquarantine the custom `rpk` binary in order to run it:

  ```
  xattr -d com.apple.quarantine <path-to-rpk>
  ```
  :::

### Set up Redpanda 

1. Start a Redpanda container with the custom `rpk` binary with data transforms enabled.

    ```bash
    rpk container start
    ```

    :::important
    - rpk expects Docker to use its default socket. To configure in Docker Desktop, go to **Settings** > **Advanced**, and enable **Allow the default Docker socket to be used**.

    - Set the `REDPANDA_*` environment variables listed in the command's output. The `rpk` commands use them when deploying the transform's WebAssembly module for this container.
    :::

2. Create the topics that this tutorial will produce and consume:

    ```bash
    rpk topic create demo-1 demo-2
    ```

### Create a data transforms project

Create and initialize a data transforms project.

```bash
rpk transform init
```

A successful command generates project files in your current directory:

```bash-no-copy
.
├── go.mod
├── go.sum
├── README.md
├── transform.go
└── transform.yaml
```

The `transform.go` contains the transform logic, and `transform.yaml` configures the project.

:::tip
 When creating a custom data transform, initialization steps can be done in `main`, because it's only run once at the start of the package, or in Golang's standard predefined `init()` function.
:::


The following examples show some basic transforms. Each example can be copied into the `transform.go` file of the project generated by `rpk transform init`.

#### Identity transform example

This transform copies data from an input topic to an output topic.

```go
package main

import (
	"github.com/rockwotj/redpanda/src/go/sdk"
)

// This example shows the basic usage of the package:
// This is a transform that does nothing but copies the same data to an new
// topic.
func main() {
	// Make sure to register your callback and perform other setup in main
	redpanda.OnRecordWritten(identityTransform)
}

// This will be called for each record in the source topic.
//
// The output records returned will be written to the destination topic.
func identityTransform(e redpanda.WriteEvent) ([]redpanda.Record, error) {
	return []redpanda.Record{e.Record()}, nil
}
```

#### Transcoder transform example

This transform converts CSV inputs into JSON outputs.

```go
package main

import (
	"bytes"
	"encoding/csv"
	"encoding/json"
	"errors"
	"io"
	"strconv"

	"github.com/rockwotj/redpanda/src/go/sdk"
)

// This example shows a transform that converts CSV into JSON.
func main() {
	redpanda.OnRecordWritten(csvToJsonTransform)
}

type Foo struct {
	A string `json:"a"`
	B int    `json:"b"`
}

func csvToJsonTransform(e redpanda.WriteEvent) ([]redpanda.Record, error) {
	// The input data is a CSV (without a header row) that is the structure of:
	// key, a, b
	reader := csv.NewReader(bytes.NewReader(e.Record().Value))
	// Improve performance by reusing the result slice.
	reader.ReuseRecord = true
	output := []redpanda.Record{}
	for {
		row, err := reader.Read()
		if err == io.EOF {
			break
		} else if err != nil {
			return nil, err
		}
		if len(row) != 3 {
			return nil, errors.New("unexpected number of rows")
		}
		// Convert the last column into an int
		b, err := strconv.Atoi(row[2])
		if err != nil {
			return nil, err
		}
		// Marshal our JSON value
		f := Foo{
			A: row[1],
			B: b,
		}
		v, err := json.Marshal(&f)
		if err != nil {
			return nil, err
		}
		// Add our output record using the first column as the key.
		output = append(output, redpanda.Record{
			Key:   []byte(row[0]),
			Value: v,
		})

	}
	return output, nil
}
```

#### Validation filter transform example

This transform is a filter that outputs only valid JSON inputs.

```go
import (
	"encoding/json"

	"github.com/rockwotj/redpanda/src/go/sdk"
)

// This example shows a filter that outputs only valid JSON into the
// output topic.
func main() {
	redpanda.OnRecordWritten(filterValidJson)
}

func filterValidJson(e redpanda.WriteEvent) ([]redpanda.Record, error) {
	v := []redpanda.Record{}
	if json.Valid(e.Record().Value) {
		v = append(v, e.Record())
	}
	return v, nil
}
```

### Build and deploy transform

1. Build the transform into a WebAssembly module.

    ```bash
    rpk transform build
    ```

1. Deploy the WebAssembly module to your cluster.

    ```bash
    rpk transform deploy --input-topic=demo-1 --output-topic=demo-2
    ```

1. To validate that your transform is running:

    1. Produce a few records to the `demo-1` topic.
    
      ```
      rpk topic produce demo-1
      ```

    
    2. Consume from the `demo-2` topic.

      ```
      rpk topic consume demo-2
      ```

      ```text-no-copy
      {
        "topic": "demo-2",
        "value": "foo",
        "timestamp": 1687545891433,
        "partition": 0,
        "offset": 0
      }
      {
        "topic": "demo-2",
        "value": "bar",
        "timestamp": 1687545892434,
        "partition": 0,
        "offset": 1
      }
      ```


## Update to new release

Follow these steps to update your project and container as new technical previews of Redpanda Data Transforms are released:

1. Repeat the step to [install `rpk`](#install-rpk). 
1. Run the following command to pull the latest Docker image:

  <Tabs groupId="architectures">
  <TabItem value="arm64" label="Apple silicon" default>

  ```bash
  docker pull us-central1-docker.pkg.dev/rp-byoc-tyler/wasm-feature-branch/redpanda:arm64
  ```

  </TabItem>

  <TabItem value="amd64" label="Linux x86-64">

  ```bash
  docker pull us-central1-docker.pkg.dev/rp-byoc-tyler/wasm-feature-branch/redpanda:amd64
  ```

  </TabItem>
  </Tabs>

1. Purge your running container, then start the newly downloaded container.

  ```bash
  rpk container purge
  rpk container start
  ```


## Data transforms FAQ -- to move

You can see `stdout` and `stderr` from the broker's logs. In the Docker container, you can use `rpk container logs --filter=transform`. Otherwise, it's sent to the broker's `stderr` output stream.

